#!/bin/bash

#    Stay fresh - Remove all caches, logs, histories and brew upgrade.
#    Copyright (C) 1995-2020  Richard Huang <rickypc@users.noreply.github.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as
#    published by the Free Software Foundation, either version 3 of the
#    License, or (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

# Source function library.
. $SCRIPT_DIR/functions

# See hidden files
shopt -s dotglob

# Prompt for sudo password early on
sudo -v

step "Clear log files"
  try sudo rm -f /var/log/*.bz2 /var/log/*.gz /var/log/*.old /var/log/*/*.gz
  try sudo find /Library/Logs/DiagnosticReports -type f -exec rm -f '{}' \; &>/dev/null
  try find ~/Library/Logs -type f -exec rm -f '{}' \; &>/dev/null
next

step "Clear history files"
  try :>~/.lesshst
  [ -f ~/.mysql_history ] && try :>~/.mysql_history
next

step "Clear Vim history files"
  try find ~/.vim/backup -mindepth 1 ! -name '.gitignore' -exec rm -rf -- {} +
  [ -d ~/.vim6 ] && try find ~/.vim6/backup -mindepth 1 ! -name '.gitignore' -exec rm -rf -- {} +
  try :>~/.viminfo
next

step "Clear caches"
  try rm -rf ~/.atom/.apm/*
  try find ~/Library/Caches -type f -exec rm -f '{}' \; &>/dev/null
  try rm -rf ~/Library/Containers/com.apple.Preview/*
  try find ~/Library/Developer/Xcode/Archives -type f -exec rm -f '{}' \; &>/dev/null
  try find ~/Library/Developer/Xcode/DerivedData -type f -exec rm -f '{}' \; &>/dev/null
  try command -v composer &>/dev/null && composer clearcache 2>/dev/null
  try command -v npm &>/dev/null && npm cache clean --force 2>/dev/null
next

# Prompt for sudo password early on
sudo -v

step "Clear Kernel caches"
  try sudo update_dyld_shared_cache -force
  try qlmanage -r
  try killall Finder
next

step "Vacuum Outlook data"
  killall "Microsoft Outlook"
  if [ -f "$HOME/Library/Group\ Containers/UBF8T346G9.Office/Outlook/Outlook\ 15\ Profiles/Main\ Profile/Data/Outlook.sqlite" ]; then
    try sqlite3 "$HOME/Library/Group\ Containers/UBF8T346G9.Office/Outlook/Outlook\ 15\ Profiles/Main\ Profile/Data/Outlook.sqlite" "PRAGMA integrity_check" && sqlite3 "$HOME/Library/Group\ Containers/UBF8T346G9.Office/Outlook/Outlook\ 15\ Profiles/Main\ Profile/Data/Outlook.sqlite" vacuum
  fi
next

# Clear docker containers and images
$SCRIPT_DIR/docker-cleanup

step "Update Homebrew formulae"
  # Update to latest Homebrew and latest formulaes as well
  brew update
next

step "Upgrade Homebrew formulae"
  # Upgrade all installed unpinned brews
  HOMEBREW_INSTALL_CLEANUP=1 brew upgrade --ignore-pinned
next

step "Clean Homebrew caches"
  # Cleanup files & symlinks older than 3 days.
  brew cleanup --prune=3 -s
  # Repair brew tap
  brew tap --repair
next

step "Activate default virtual env"
  try rm -rf $WORKON_HOME/default
  try $SCRIPT_DIR/get-virtualenv
  try . $WORKON_HOME/default/bin/activate
next

step "Activate Powerline"
  PYTHON_USER_BASE=`python3 -m site --user-base`

  if [ -d "$PYTHON_USER_BASE/bin" ]; then
    export PYTHON_USER_SITE=`python3 -m site --user-site`

    if [[ -n "$PYTHON_USER_BASE/bin" && $PATH != *$PYTHON_USER_BASE/bin* ]]; then
      export PATH=$PATH:$PYTHON_USER_BASE/bin
    fi
  fi

  if [ -z "$(pip3 list --user | grep powerline-gitstatus)" ]; then
    try pip3 install --user awscli gitpython powerline-gitstatus powerline-status
    try powerline-daemon -q
  else
    try powerline-daemon --replace
  fi
next

# Prompt for sudo password early on
sudo -v

step "Purge inactive memory"
  try sudo purge
next

# Clear {ba|z}sh history
step "Clear shell history"
  :>~/.bash_history
  :>~/.zsh_history
  history -c
next
