#!/bin/bash

#    Get Python Virtual Environment - Install Python 3.x virtual environment
#    and set those to the path.
#    Copyright Â© 2015 Richard Huang <rickypc@users.noreply.github.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as
#    published by the Free Software Foundation, either version 3 of the
#    License, or (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

# Source function library.
. ~/bin/functions

NAME="${1:-default}"
SYSTEM_VER=$(/usr/bin/python3 --version 2>&1 | awk '{print $2}' | cut -d. -f1-2)
WORKON_HOME="${WORKON_HOME:-$HOME/.venv}"
# After $WORKON_HOME assignment.
TARGET_DIR="$WORKON_HOME/${NAME/default/$PYTHON_LTS}"

# Need to deactivate outside this script.
# [ -n "$VIRTUAL_ENV" ] && type deactivate &>/dev/null && deactivate
if [ "$NAME" = "default" ]; then
  rm -rf "$(readlink -f "$WORKON_HOME/default")" "$WORKON_HOME/default"
else
  rm -rf "$TARGET_DIR"
fi
if [ "$NAME" = "$SYSTEM_VER" ]; then
  /usr/bin/python3 -m venv "$TARGET_DIR"
else
  "$LOCAL_BIN/python3" -m venv "$TARGET_DIR"
fi
if [ "$NAME" = "default" ]; then
  ln -sf "$TARGET_DIR" "$WORKON_HOME/default"
fi
# Need to activate outside this script.
# source "$TARGET_DIR/bin/activate"

echo "This script can't modify your shell environment."
echo "Run 'deactivate' to exit, then 'source \"$TARGET_DIR/bin/activate\"' to enter the new venv."
